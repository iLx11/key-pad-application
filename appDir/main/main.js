"use strict";const g=require("electron"),R=require("path"),{ipcMain:S,BrowserWindow:y}=require("electron"),z=()=>{S.on("window-min",t=>{const n=t.sender;y.fromWebContents(n).minimize()}),S.on("window-max",t=>{const n=t.sender,r=y.fromWebContents(n);r.isMaximized()?r.unmaximize():r.maximize()}),S.on("window-close",t=>{const n=t.sender;y.fromWebContents(n).close()})},$=require("path"),x=class u{constructor(){this.getWindowById=n=>g.BrowserWindow.fromId(n),this.defaultConfig={id:null,title:"",width:null,height:null,minWidth:null,minHeight:null,route:"",resizable:!0,maximize:!1,backgroundColor:"#eee",data:null,isMultiWindow:!1,isMainWin:!1,parentId:null,modal:!0},this.defaultOptions={width:900,height:700,center:!0,frame:!1,show:!0,transparent:!0,maxWidth:null,maxHeight:null,minWidth:680,minHeight:500,backgroundColor:"rgba(0,0,0,0)",autoHideMenuBar:!0,resizable:!0,minimizable:!0,maximizable:!0,modal:!0,parent:null,webPreferences:{contextIsolation:!0,webSecurity:!1,nodeIntegration:!0,preload:$.join(__dirname,"../preload/preload.js")}}}createWindow(n,r){var d;let o=0;if(u.group.some((w,p)=>(o=p,w.route===n.route))){console.info("window is already created"),(d=this.getWindowById(o+1))==null||d.blur();return}let e=Object.assign({},this.defaultConfig,n),a=Object.assign({},this.defaultOptions,r);!e.isMainWin&&u.main&&(a.parent=u.main);let i=new g.BrowserWindow(a);console.log("window id:"+i.id),u.group[i.id-1]={windowId:i.id,route:e.route},e.maximize&&e.resizable&&i.maximize(),e.isMainWin&&(u.main&&(console.info("main window already created"),delete u.group[0],u.main.close()),u.main=i);let c=this;i.on("close",()=>{u.group.forEach((w,p)=>{this.getWindowById(w.windowId)==i&&delete u.group[p],i==c.main&&g.app.quit()}),i.setOpacity(0)});let f;return g.app.isPackaged?i.loadFile(R.join(__dirname,"../../dist/index.html"),{hash:e.route}):(f=e.route?`http://localhost:${process.env.VITE_DEV_SERVER_PORT}/#${e.route}`:`http://localhost:${process.env.VITE_DEV_SERVER_PORT}/#`,i.loadURL(f)),console.info("new window address -> ",f),i.setMenu(null),i.on("hide",()=>i.webContents.closeDevTools()),g.globalShortcut.register("CommandOrControl+Shift+i",function(){i.webContents.openDevTools()}),i.once("ready-to-show",()=>{i.show()}),i}};x.group=[];x.main=null;let v=x;const{dialog:B}=require("electron"),E=async()=>await B.showOpenDialog({title:"选择一个文件",buttonLabel:"确认选择",filters:[{name:"应用/文件",extensions:[]}]}),{SerialPort:C}=require("serialport"),s=class{};s.wait=null;s.waitState=!1;s.connectState=!1;s.HardwarePort={};s.connectHardware=async()=>{if(s.connectState)return new Promise(r=>r(!0));let t=[];try{t=await C.list()}catch(r){return console.info(r),s.connectState=!1,s.HardwarePort={},new Promise(o=>o(!1))}if(t.length==0)return console.info("no serial port"),s.connectState=!1,new Promise(r=>r(!1));let n=3;for(;!s.connectState&&n>0;){console.info(n);for(let r=0;r<t.length;r++){let o=new C({path:t[r].path,baudRate:115200},e=>{if(e)return s.errorHandle(e);console.log("port open success")});o.on("error",e=>s.errorHandle(e)),o.on("data",e=>{if(e[0]==170&&e[1]==187&&e[2]==204){s.HardwarePort=o,s.connectState=!0;return}s.dataHandle(e)}),o.on("close",()=>(console.info("serial close listen"),s.errorHandle())),o.write(new Uint8Array([170,187,204])),o.drain(e=>{if(e)return s.errorHandle(e);console.info("send ok")}),await new Promise(e=>setTimeout(e,500)),n--,s.connectState||(s.HardwarePort={},o.close(e=>{if(e)return s.errorHandle(e);console.info("close success")}))}}return s.connectState?(console.info("connect success"),new Promise(r=>r(!0))):(console.info("no hardware input"),new Promise(r=>r(!1)))};s.errorHandle=async t=>{var n;return s.connectState&&((n=s.HardwarePort)==null||n.close(r=>{if(r)return s.errorHandle(r);console.info("close success")})),s.connectState=!1,s.HardwarePort={},new Promise(r=>r(!1))};s.sendData=async t=>{var n,r;return s.connectState&&Object.keys(s.HardwarePort).length!=0?((n=s.HardwarePort)==null||n.write(Buffer.from(t)),(r=s.HardwarePort)==null||r.drain(o=>o?new Promise(e=>e(!1)):new Promise(e=>e(!0))),new Promise(o=>o(!0))):new Promise(o=>o(!1))};s.dataHandle=t=>{t[0]==119&&(s.waitState=!0,console.info("data send"))};s.waitSign=async()=>(await new Promise(t=>s.wait=setInterval(()=>{s.waitState&&(clearInterval(s.wait),s.wait=null,s.waitState=!1,t(!0))},1)).catch(()=>new Promise(t=>t(!1))),new Promise(t=>t(!0)));let H=s;const F=require("os"),O=require("path"),j=require("crypto"),L=require("pngparse"),_=require("sharp"),D=require("fs-extra"),l=class{static generateTemFile(n){let r=j.createHash("md5").update("angular-tmp-img").digest("hex")+".bmp",o=O.join(F.tmpdir(),r),e=Buffer.from(n.replace(/^data:image\/\w+;base64,/,""),"base64");return D.writeFileSync(o,e),o}static convert(n,r){let o=this;o.pngtolcd(n,function(e,a){e?r(e,null):r(null,o.configArray[3]==0?o.hex2hex(a.toString("hex")):a)})}};l.generate=(t,n,r)=>(l.configArray=r,l.threshold=n,new Promise((o,e)=>{l.convert(l.generateTemFile(t),function(a,i){a?e(a):o(i)})}));l.pngtolcd=(t,n)=>{let r=l;L.parseFile(t,function(o,e){if(o){let i=r.imgFileToBuffer(t);return n(null,i)}let a=r.imageDataToHexArray(e);n(null,a)})};l.imgFileToBuffer=t=>{_(t).toBuffer().then(n=>n)};l.imageDataToHexArray=t=>{const n=l.createImageDate(t);let r=n.data,o=n.height,e=n.width,a=r.length;if(l.configArray[4]==1){let i=l.threshold,c=[],f=4,d;for(let w=0;w<a;w+=f)d=r[w+1]=r[w+2]=r[w],d>i?d=1:d=0,c[w/f]=d;return l.imageSamplingArr[l.configArray[1]](c,e,o)}else return l.colorImageSampling(r,e,o)};l.colorImageSampling=(t,n,r)=>{const o=Buffer.alloc(n*r*2);let e=0,a=0;for(;e<o.length&&a<t.length;)o[e]|=t[a]>>3<<3,o[e]|=t[a+1]>>5,o[e+1]|=t[a+1]>>2<<5,o[e+1]|=t[a+2]>>3,(l.configArray[0]==0||l.configArray[2]==1)&&(o[e]=~o[e],o[e+1]=~o[e+1]),e+=2,a+=4;return o};l.ImageSamplingRow=(t,n,r)=>{const o=Buffer.alloc(n*r/8);for(let e=0;e<t.length;e++){let a=Math.floor(e%n),i=Math.floor(e/n),c=0,f=i,d=1<<a%8;l.configArray[2]!=0&&(d=1<<7-a%8),c=f*Math.floor(n/8)+Math.floor(a/8),l.configArray[0]!==0&&(t[e]===0?t[e]=1:t[e]=0),t[e]===0?o[c]|=d:o[c]&=~d}return o};l.ImageSamplingCol=(t,n,r)=>{const o=Buffer.alloc(n*r/8);for(let e=0;e<t.length;e++){let a=Math.floor(e%n),i=Math.floor(e/n),c=0,f=a,d=1<<i%8;l.configArray[2]!=0&&(d=1<<7-i%8),c=f*Math.floor(r/8)+Math.floor(i/8),l.configArray[0]!==0&&(t[e]===0?t[e]=1:t[e]=0),t[e]===0?o[c]|=d:o[c]&=~d}return o};l.ImageSamplingColRow=(t,n,r)=>{const o=Buffer.alloc(n*r/8);for(let e=0;e<t.length;e++){let a=Math.floor(e%n),i=Math.floor(e/n),c=0,f=Math.floor(i/8),d=1<<i-8*f;l.configArray[2]!=0&&(d=1<<7-(i-8*f)),f===0?c=a:c=a+n*f,l.configArray[0]!==0&&(t[e]===0?t[e]=1:t[e]=0),t[e]===0?o[c]|=d:o[c]&=~d}return o};l.ImageSamplingRowCol=(t,n,r)=>{const o=Buffer.alloc(n*r/8);for(let e=0;e<t.length;e++){let a=Math.floor(e%n),i=Math.floor(e/n),c=0,f=Math.floor(a/8),d=1<<a%8;l.configArray[2]!=0&&(d=1<<7-a%8),c=f*r+i,l.configArray[0]!==0&&(t[e]===0?t[e]=1:t[e]=0),t[e]===0?o[c]|=d:o[c]&=~d}return o};l.imageSamplingArr=[l.ImageSamplingRow,l.ImageSamplingCol,l.ImageSamplingColRow,l.ImageSamplingRowCol];l.createImageDate=t=>{let n=Buffer.alloc(t.width*t.height*4);for(let r=0,o=0;r<t.height;r++)for(let e=0;e<t.width;e++)n.writeUInt32BE(l.getPixel(t,e,r),o),o+=4;return t.data.set(n),t};l.getPixel=(t,n,r)=>{if(n=n|0,r=r|0,n<0||r<0||n>=t.width||r>=t.height)return 0;let o=(r*t.width+n)*t.channels,e,a,i,c;switch(t.channels){case 1:e=a=i=t.data[o],c=255;break;case 2:e=a=i=t.data[o],c=t.data[o+1];break;case 3:e=t.data[o],a=t.data[o+1],i=t.data[o+2],c=255;break;case 4:e=t.data[o],a=t.data[o+1],i=t.data[o+2],c=t.data[o+3];break}return(e<<24|a<<16|i<<8|c)>>>0};l.hex2hex=t=>{for(var n=[],r=0;r<t.length;r+=2)n.push("0x"+t.substr(r,2));return n};l.pngtohexarray=(t,n)=>{l.pngtolcd(t,function(r,o){r?n(r,null):n(null,this.hex2hex(o.toString("hex")))})};let V=l;const{ipcMain:W}=require("electron"),I=require("sharp"),M=require("crypto"),A=require("os"),U=require("fs-extra"),q=require("path");let b="";const G=async(t,n,r,o)=>{if(t==0||n==0)return;let e=M.createHash("md5").update("angular-cir-img").digest("hex")+".bmp",a=q.join(A.tmpdir(),e),i=Buffer.from(r.replace(/^data:image\/\w+;base64,/,""),"base64");U.writeFileSync(a,i),q.join(A.tmpdir(),M.createHash("md5").update("angular-cir-img-zoom").digest("hex")+".bmp"),o?I(a).resize(t,n).greyscale().toBuffer().then(c=>{b=c.toString("base64")}):I(a).resize(t,n).toBuffer().then(c=>{b=c.toString("base64")})},J=()=>{W.handle("pic-data-editor",async(t,n,r,o,e)=>(G(n,r,o,e),await new Promise(a=>setTimeout(a,700)),b)),W.handle("pic-data-parse",async(t,n,r,...o)=>await V.generate(n,r,o))},{app:m,protocol:K,BrowserWindow:P,ipcMain:h}=require("electron");require("path");z();J();h.on("window-create",(t,n,r)=>{new v().createWindow(n,r)});h.handle("select-file",async()=>await E());h.on("store-set",(t,n)=>{for(const r of P.getAllWindows())r!=P.fromWebContents(t.sender)&&r.webContents.send("store-get",n)});h.handle("wait-sign",async()=>await H.waitSign());h.handle("connection-state",async()=>await H.connectHardware());h.handle("send-data",async(t,n)=>await H.sendData(n));const T=async()=>{new v().createWindow({route:"/home",isMainWin:!0},{width:680,height:500,maxWidth:680,maxHeight:500})};m.commandLine.appendSwitch("--ignore-certificate-errors","true");K.registerSchemesAsPrivileged([{scheme:"app",privileges:{secure:!0,standard:!0}}]);m.whenReady().then(()=>{T(),m.on("activate",()=>{P.getAllWindows().length===0&&T()})});m.on("window-all-closed",()=>{process.platform!=="darwin"&&m.quit()});
